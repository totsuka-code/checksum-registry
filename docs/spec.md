# Checksum Registry 仕様書 v0.1（確定版）

本仕様は実装基準であり、後続実装は本書に厳密に従う。

## 1. システム概要
- アプリ種別: FastAPI + ブラウザUI
- 利用範囲: ローカル専用
- バインド先: `127.0.0.1` のみ
- 外部通信: 禁止（外部HTTP/HTTPS呼び出し、外部DB接続、外部API連携を実装しない）
- 永続化: `data/ledger.json`
- 対応ハッシュ: SHA-256
- 台帳方式: ブロックチェーン風の追記台帳（改ざん検知あり）
- 台帳更新方針: 追記のみ（更新API・削除APIは作成しない）
- 対象ファイルサイズ: 約1GBまで（チャンク読み取りで計算）

## 2. 画面一覧
- `/` 単一ページUI（4セクション構成）
- セクション1: 登録
- セクション2: 検証
- セクション3: 一覧
- セクション4: 台帳検証

## 3. 画面仕様

## 3.1 登録セクション
- 入力項目:
- `name`（必須、1〜100文字）
- `version`（必須、1〜50文字）
- `file`（必須）
- ボタン: `登録する`
- 成功時表示:
- `登録完了: {name} {version} / sha256={sha256}`
- 失敗時表示:
- 409: `同じ name/version は登録済みです`
- 400: `入力値が不正です`
- 500: `登録処理に失敗しました`

## 3.2 検証セクション
- 入力項目:
- `name`（任意、空文字可）
- `version`（任意、空文字可）
- `file`（必須）
- ボタン: `検証する`
- 判定ルール:
- `name` と `version` が両方入力されている場合: 完全一致レコードのみ対象
- `name` または `version` が空の場合: SHA-256一致のみで判定し、最初の一致（最小index）を返す
- 成功時表示:
- `検証成功: 登録情報と一致しました（name={name}, version={version}, sha256={sha256}）`
- 不一致時表示:
- `一致する登録が見つかりません`
- 失敗時表示:
- 400: `入力値が不正です`
- 500: `検証処理に失敗しました`

## 3.3 一覧セクション
- ボタン: `再読み込み`
- 表示列:
- `index`
- `timestamp_utc`
- `name`
- `version`
- `sha256`
- `file_size_bytes`
- `original_filename`
- 表示順:
- `index` 昇順（genesisは表示しない）

## 3.4 台帳検証セクション
- ボタン: `台帳を検証する`
- 成功時表示:
- `台帳検証成功: すべてのブロック整合性が有効です`
- 失敗時表示:
- `台帳検証失敗: index={index} のブロックが不正です（reason={reason}）`

## 4. 操作フロー

## 4.1 初回起動
1. アプリ起動時に `data/ledger.json` を確認する。
2. ファイルが存在しない場合は genesis ブロックを作成して保存する。
3. UIにアクセス可能状態にする。

## 4.2 登録フロー
1. ユーザーが `name` `version` `file` を入力して `登録する` を押下。
2. サーバーがファイルSHA-256をチャンク計算。
3. 既存台帳に同一 `name+version` が存在するか確認。
4. 存在する場合は 409 を返す。
5. 存在しない場合は新規ブロックを追記し、201を返す。

## 4.3 検証フロー
1. ユーザーが `file` と任意の `name` `version` を入力して `検証する` を押下。
2. サーバーがファイルSHA-256をチャンク計算。
3. 判定条件に従って台帳検索。
4. 一致があれば200、一致なしは404を返す。

## 4.4 台帳検証フロー
1. ユーザーが `台帳を検証する` を押下。
2. サーバーが genesis から末尾まで順に検証。
3. `prev_hash` と `block_hash` の整合性を確認。
4. 全件正常なら200、不正があれば409を返す。

## 5. 非機能要件
- ハッシュ計算はチャンクサイズ `4,194,304 bytes (4 MiB)` で読み込む。
- 文字コードは UTF-8。
- 時刻は UTC ISO8601（例: `2026-02-21T12:34:56Z`）。
- サーバー起動時オプションは `--host 127.0.0.1` を必須とする。
- APIは `/api/v1` プレフィックス配下のみ公開する。
