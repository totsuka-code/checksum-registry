# Checksum Registry 仕様書 v0.2（確定版）

本仕様は実装基準であり、後続実装は本書に厳密に従う。

## 1. システム概要
- アプリ種別: FastAPI + ブラウザUI
- 利用範囲: ローカル専用
- バインド先: `127.0.0.1` のみ
- 外部通信: 禁止（外部HTTP/HTTPS呼び出し、外部DB接続、外部API連携を実装しない）
- 永続化:
- 台帳: `data/ledger.json`
- 外部アンカー: `anchors/latest.json`
- 対応ハッシュ: SHA-256
- 台帳方式: ブロックチェーン風の追記台帳（改ざん検知 + 署名検証）
- 署名方式: Ed25519
- 公開鍵検証基点（Trust Anchor）: `keys/public_key.pem` 固定
- 台帳更新方針: 追記のみ（更新API・削除APIは作成しない）
- 対象ファイルサイズ: 約1GBまで（チャンク読み取りで計算）

## 2. v0.2追加要件
- すべてのブロック（genesis/record）に `signing_key_id` と `signature` を持たせる。
- `signature` は Ed25519 署名結果を base64 文字列化した値とする。
- 署名対象は `block_hash` の32バイト値（16進文字列をバイト列に戻した値）とする。
- `keys/public_key.pem` が存在しない場合、アプリは起動失敗とする。
- `keys/private_key.pem` は開発用秘密鍵ファイルとして扱い、リポジトリ追跡対象外とする（`.gitignore` に追加する）。
- 最新ブロック確定点を `anchors/latest.json` に書き出す。
- アンカーは「人が別媒体に貼るための出力」であり、台帳本体とは別管理とする。

## 3. 互換性方針（v0.1 → v0.2）
- v0.2 の `data/ledger.json` は新規作成を必須とする。
- 既存 v0.1 台帳は読み取り専用の参考データとして扱う。
- v0.1 台帳は署名フィールドを持たないため、v0.2 の署名検証対象外とする。
- v0.1 台帳を v0.2 に取り込む場合は、オフライン移行手順でブロック再生成・再署名を行う。
- 自動インプレース移行は実施しない。

## 4. 画面一覧
- `/` 単一ページUI（4セクション構成）
- セクション1: 登録
- セクション2: 検証
- セクション3: 一覧
- セクション4: 台帳検証

## 5. 画面仕様

## 5.1 登録セクション
- 入力項目:
- `name`（必須、1〜100文字）
- `version`（必須、1〜50文字）
- `file`（必須）
- ボタン: `登録する`
- 成功時表示:
- `登録完了: {name} {version} / sha256={sha256}`
- `署名: key_id={signing_key_id}`
- 失敗時表示:
- 409: `同じ name/version は登録済みです`
- 400: `入力値が不正です`
- 500: `登録処理に失敗しました`

## 5.2 検証セクション
- 入力項目:
- `name`（任意、空文字可）
- `version`（任意、空文字可）
- `file`（必須）
- ボタン: `検証する`
- 判定ルール:
- `name` と `version` が両方入力されている場合: `name/version/sha256` 完全一致レコードのみ対象
- `name` または `version` が空の場合: `sha256` 一致のみで判定し、最初の一致（最小index）を返す
- 成功時表示:
- `検証成功: 登録情報と一致しました（name={name}, version={version}, sha256={sha256}）`
- `署名: key_id={signing_key_id}`
- 不一致時表示:
- `一致する登録が見つかりません`
- 失敗時表示:
- 400: `入力値が不正です`
- 500: `検証処理に失敗しました`

## 5.3 一覧セクション
- ボタン: `再読み込み`
- 表示列:
- `index`
- `timestamp_utc`
- `name`
- `version`
- `sha256`
- `file_size_bytes`
- `original_filename`
- `signing_key_id`
- `signature`
- 表示順:
- `index` 昇順（genesisは表示しない）

## 5.4 台帳検証セクション
- ボタン: `台帳を検証する`
- 成功時表示:
- `台帳検証成功: すべてのブロック整合性と署名が有効です`
- 失敗時表示:
- `台帳検証失敗: index={index} のブロックが不正です（reason={reason}）`

## 6. 操作フロー

## 6.1 初回起動
1. 起動前提として `keys/public_key.pem` の存在を確認する。
2. 存在しない場合は起動エラーとして終了する。
3. `data/ledger.json` を確認する。
4. ファイルが存在しない場合は署名付きgenesisブロックを作成して保存する。
5. `anchors/latest.json` を genesis 情報で生成する。
6. UIにアクセス可能状態にする。

## 6.2 登録フロー
1. ユーザーが `name` `version` `file` を入力して `登録する` を押下。
2. サーバーがファイルSHA-256をチャンク計算。
3. 既存台帳に同一 `name+version` が存在するか確認。
4. 存在する場合は 409 を返す。
5. 存在しない場合は新規ブロックを作成し、`block_hash` を算出する。
6. `block_hash` を Ed25519 で署名して `signature` と `signing_key_id` を設定する。
7. 新規ブロックを台帳末尾に追記する。
8. `anchors/latest.json` を当該ブロック情報で更新する。
9. 201を返す。

## 6.3 検証フロー
1. ユーザーが `file` と任意の `name` `version` を入力して `検証する` を押下。
2. サーバーがファイルSHA-256をチャンク計算。
3. 判定条件に従って台帳検索。
4. 一致があれば200、一致なしは404を返す。

## 6.4 台帳検証フロー
1. ユーザーが `台帳を検証する` を押下。
2. サーバーが genesis から末尾まで順に検証する。
3. `prev_hash` と `block_hash` の整合性を確認する。
4. 各ブロックの Ed25519 署名を `keys/public_key.pem` で検証する。
5. 全件正常なら200、不正があれば409を返す。

## 7. 非機能要件
- ハッシュ計算はチャンクサイズ `4,194,304 bytes (4 MiB)` で読み込む。
- 文字コードは UTF-8。
- 時刻は UTC ISO8601（例: `2026-02-21T12:34:56Z`）。
- サーバー起動時オプションは `--host 127.0.0.1` を必須とする。
- APIは `/api/v1` プレフィックス配下のみ公開する。
- 署名鍵IDは文字列固定長 1〜128 とし、同一公開鍵に対して不変値を使用する。
- `anchors/latest.json` は台帳追記のたびに上書き更新する。
